# ProductCatalog API - Database Schema

Complete database schema documentation including entity relationships, table structures, and migration strategy.

## Table of Contents

- [Overview](#overview)
- [Database Information](#database-information)
- [Entity Relationship Diagram](#entity-relationship-diagram)
- [Table Schemas](#table-schemas)
- [Relationships](#relationships)
- [Indexes](#indexes)
- [Constraints](#constraints)
- [Migrations](#migrations)
- [Seed Data](#seed-data)
- [Query Examples](#query-examples)

---

## Overview

The ProductCatalog API uses **PostgreSQL 16** as the primary database, managed through **Entity Framework Core 10** with Code-First approach.

### Key Features

✅ **Code-First Migrations** - Database schema defined in C# code
✅ **Data Annotations** - Entity validation and constraints
✅ **Fluent API** - Advanced entity configuration
✅ **Soft Deletes** - Discontinued flag instead of hard deletes
✅ **Audit Fields** - CreatedAt, UpdatedAt timestamps
✅ **Referential Integrity** - Foreign key constraints
✅ **Indexing Strategy** - Optimized for common queries

---

## Database Information

| Property | Value |
|----------|-------|
| **Database System** | PostgreSQL 16 |
| **ORM** | Entity Framework Core 10 |
| **Connection Pooling** | Enabled (Npgsql default) |
| **Default Port** | 5432 |
| **Database Name** | ProductCatalogDb |
| **Character Set** | UTF-8 |
| **Timezone** | UTC |

### Connection String

**Development**:
```
Host=localhost;Port=5432;Database=ProductCatalogDb;Username=postgres;Password=postgres
```

**Production** (Docker):
```
Host=postgres;Port=5432;Database=ProductCatalogDb;Username=productcatalog;Password=${POSTGRES_PASSWORD}
```

---

## Entity Relationship Diagram

```
┌─────────────────┐
│     Users       │
│─────────────────│
│ PK Id           │
│    Username     │
│    PasswordHash │
│    Role         │
└─────────────────┘

┌─────────────────┐         ┌─────────────────┐
│   Categories    │         │    Suppliers    │
│─────────────────│         │─────────────────│
│ PK Id           │         │ PK Id           │
│    Name         │         │    Name         │
│    Description  │         │    ContactName  │
│    Discontinued │         │    Phone        │
│    CreatedAt    │         │    Email        │
│    UpdatedAt    │         │    Address      │
└────────┬────────┘         │    Country      │
         │                  │    Discontinued │
         │                  │    CreatedAt    │
         │                  │    UpdatedAt    │
         │                  └────────┬────────┘
         │                           │
         │ 1                         │ 1
         │                           │
         │ N                         │ N
         │                           │
         └───────────┬───────────────┘
                     │
              ┌──────▼──────┐
              │  Products   │
              │─────────────│
              │ PK Id       │
              │ FK CategoryId
              │ FK SupplierId
              │    Name     │
              │    Description
              │    Price    │
              │    StockQuantity
              │    SKU      │
              │    Discontinued
              │    CreatedAt│
              │    UpdatedAt│
              └──────┬──────┘
                     │
                     │ 1
                     │
                     │ 1 (optional)
                     │
              ┌──────▼──────┐
              │  Inventory  │
              │─────────────│
              │ PK Id       │
              │ FK ProductId│
              │    Quantity │
              │    MinimumStock
              │    MaximumStock
              │    ReorderLevel
              │    LastRestockDate
              │    CreatedAt│
              │    UpdatedAt│
              └─────────────┘
```

### Relationship Summary

| Parent Table | Child Table | Relationship | Constraint |
|--------------|-------------|--------------|------------|
| Categories | Products | One-to-Many | CategoryId FK |
| Suppliers | Products | One-to-Many | SupplierId FK |
| Products | Inventory | One-to-One | ProductId FK |

---

## Table Schemas

### Users Table

Stores user accounts for authentication and authorization.

```sql
CREATE TABLE "Users" (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "Username" character varying(50) NOT NULL,
    "PasswordHash" text NOT NULL,
    "Role" integer NOT NULL,
    CONSTRAINT "PK_Users" PRIMARY KEY ("Id")
);

CREATE UNIQUE INDEX "IX_Users_Username" ON "Users" ("Username");
```

**Columns**:

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| Id | integer | NOT NULL | Primary key (auto-increment) |
| Username | varchar(50) | NOT NULL | Unique username (3-50 chars) |
| PasswordHash | text | NOT NULL | BCrypt hashed password |
| Role | integer | NOT NULL | UserRole enum: 0=User, 1=Admin |

**Entity Definition**:
```csharp
public class User
{
    public int Id { get; set; }

    [Required]
    [StringLength(50, MinimumLength = 3)]
    public string Username { get; set; } = string.Empty;

    [Required]
    public string PasswordHash { get; set; } = string.Empty;

    public UserRole Role { get; set; } = UserRole.User;
}

public enum UserRole
{
    User = 0,
    Admin = 1
}
```

**Seed Data**:
- Default admin account: `admin / Admin123!` (BCrypt hashed)

---

### Categories Table

Organizes products into categories.

```sql
CREATE TABLE "Categories" (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(100) NOT NULL,
    "Description" text,
    "Discontinued" boolean NOT NULL DEFAULT false,
    "CreatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "PK_Categories" PRIMARY KEY ("Id")
);

CREATE INDEX "IX_Categories_Name" ON "Categories" ("Name");
CREATE INDEX "IX_Categories_Discontinued" ON "Categories" ("Discontinued");
```

**Columns**:

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| Id | integer | NOT NULL | AUTO | Primary key |
| Name | varchar(100) | NOT NULL | - | Category name (unique) |
| Description | text | NULL | - | Category description |
| Discontinued | boolean | NOT NULL | false | Soft delete flag |
| CreatedAt | timestamptz | NOT NULL | NOW | Creation timestamp |
| UpdatedAt | timestamptz | NOT NULL | NOW | Last update timestamp |

**Entity Definition**:
```csharp
public class Category
{
    public int Id { get; set; }

    [Required]
    [StringLength(100, MinimumLength = 2)]
    public string Name { get; set; } = string.Empty;

    [StringLength(500)]
    public string? Description { get; set; }

    public bool Discontinued { get; set; } = false;

    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation property
    public ICollection<Product> Products { get; set; } = new List<Product>();
}
```

**Business Rules**:
- Name must be unique
- Cannot delete category with active products (set Discontinued = true)
- Discontinued categories hidden from default queries

---

### Suppliers Table

Manages product suppliers and vendors.

```sql
CREATE TABLE "Suppliers" (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(100) NOT NULL,
    "ContactName" character varying(100),
    "Phone" character varying(20),
    "Email" character varying(100),
    "Address" text,
    "Country" character varying(50),
    "Discontinued" boolean NOT NULL DEFAULT false,
    "CreatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "PK_Suppliers" PRIMARY KEY ("Id")
);

CREATE INDEX "IX_Suppliers_Name" ON "Suppliers" ("Name");
CREATE INDEX "IX_Suppliers_Country" ON "Suppliers" ("Country");
CREATE INDEX "IX_Suppliers_Discontinued" ON "Suppliers" ("Discontinued");
```

**Columns**:

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| Id | integer | NOT NULL | Primary key |
| Name | varchar(100) | NOT NULL | Supplier name |
| ContactName | varchar(100) | NULL | Contact person name |
| Phone | varchar(20) | NULL | Phone number |
| Email | varchar(100) | NULL | Email address |
| Address | text | NULL | Full address |
| Country | varchar(50) | NULL | Country name |
| Discontinued | boolean | NOT NULL | Soft delete flag |
| CreatedAt | timestamptz | NOT NULL | Creation timestamp |
| UpdatedAt | timestamptz | NOT NULL | Last update timestamp |

**Entity Definition**:
```csharp
public class Supplier
{
    public int Id { get; set; }

    [Required]
    [StringLength(100)]
    public string Name { get; set; } = string.Empty;

    [StringLength(100)]
    public string? ContactName { get; set; }

    [Phone]
    [StringLength(20)]
    public string? Phone { get; set; }

    [EmailAddress]
    [StringLength(100)]
    public string? Email { get; set; }

    public string? Address { get; set; }

    [StringLength(50)]
    public string? Country { get; set; }

    public bool Discontinued { get; set; } = false;

    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation property
    public ICollection<Product> Products { get; set; } = new List<Product>();
}
```

---

### Products Table

Main table for product information.

```sql
CREATE TABLE "Products" (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(200) NOT NULL,
    "Description" text,
    "Price" numeric(18,2) NOT NULL,
    "StockQuantity" integer NOT NULL DEFAULT 0,
    "SKU" character varying(50),
    "CategoryId" integer NOT NULL,
    "SupplierId" integer,
    "Discontinued" boolean NOT NULL DEFAULT false,
    "CreatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "PK_Products" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Products_Categories" FOREIGN KEY ("CategoryId")
        REFERENCES "Categories" ("Id") ON DELETE RESTRICT,
    CONSTRAINT "FK_Products_Suppliers" FOREIGN KEY ("SupplierId")
        REFERENCES "Suppliers" ("Id") ON DELETE SET NULL,
    CONSTRAINT "CK_Products_Price" CHECK ("Price" >= 0),
    CONSTRAINT "CK_Products_StockQuantity" CHECK ("StockQuantity" >= 0)
);

CREATE INDEX "IX_Products_CategoryId" ON "Products" ("CategoryId");
CREATE INDEX "IX_Products_SupplierId" ON "Products" ("SupplierId");
CREATE INDEX "IX_Products_Name" ON "Products" ("Name");
CREATE INDEX "IX_Products_SKU" ON "Products" ("SKU");
CREATE INDEX "IX_Products_Discontinued" ON "Products" ("Discontinued");
CREATE INDEX "IX_Products_Price" ON "Products" ("Price");
```

**Columns**:

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| Id | integer | NOT NULL | AUTO | Primary key |
| Name | varchar(200) | NOT NULL | - | Product name |
| Description | text | NULL | - | Product description |
| Price | decimal(18,2) | NOT NULL | - | Product price (≥ 0) |
| StockQuantity | integer | NOT NULL | 0 | Available stock (≥ 0) |
| SKU | varchar(50) | NULL | - | Stock keeping unit |
| CategoryId | integer | NOT NULL | - | FK to Categories |
| SupplierId | integer | NULL | - | FK to Suppliers (optional) |
| Discontinued | boolean | NOT NULL | false | Soft delete flag |
| CreatedAt | timestamptz | NOT NULL | NOW | Creation timestamp |
| UpdatedAt | timestamptz | NOT NULL | NOW | Last update timestamp |

**Entity Definition**:
```csharp
public class Product
{
    public int Id { get; set; }

    [Required]
    [StringLength(200, MinimumLength = 3)]
    public string Name { get; set; } = string.Empty;

    [StringLength(2000)]
    public string? Description { get; set; }

    [Range(0, double.MaxValue)]
    [Column(TypeName = "decimal(18, 2)")]
    public decimal Price { get; set; }

    [Range(0, int.MaxValue)]
    public int StockQuantity { get; set; } = 0;

    [StringLength(50)]
    public string? SKU { get; set; }

    // Foreign Keys
    [Required]
    public int CategoryId { get; set; }
    public int? SupplierId { get; set; }

    public bool Discontinued { get; set; } = false;

    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation properties
    public Category Category { get; set; } = null!;
    public Supplier? Supplier { get; set; }
    public Inventory? Inventory { get; set; }
}
```

**Business Rules**:
- Price must be non-negative (CHECK constraint)
- StockQuantity must be non-negative (CHECK constraint)
- CategoryId is required (cannot be NULL)
- SupplierId is optional
- Discontinued products are soft-deleted

---

### Inventory Table

Advanced inventory tracking for products.

```sql
CREATE TABLE "Inventory" (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "ProductId" integer NOT NULL,
    "Quantity" integer NOT NULL DEFAULT 0,
    "MinimumStock" integer NOT NULL DEFAULT 10,
    "MaximumStock" integer NOT NULL DEFAULT 1000,
    "ReorderLevel" integer NOT NULL DEFAULT 20,
    "LastRestockDate" timestamp with time zone,
    "CreatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "PK_Inventory" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Inventory_Products" FOREIGN KEY ("ProductId")
        REFERENCES "Products" ("Id") ON DELETE CASCADE,
    CONSTRAINT "CK_Inventory_Quantity" CHECK ("Quantity" >= 0),
    CONSTRAINT "CK_Inventory_Stock_Levels"
        CHECK ("MinimumStock" <= "ReorderLevel" AND "ReorderLevel" <= "MaximumStock")
);

CREATE UNIQUE INDEX "IX_Inventory_ProductId" ON "Inventory" ("ProductId");
```

**Columns**:

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| Id | integer | NOT NULL | AUTO | Primary key |
| ProductId | integer | NOT NULL | - | FK to Products (unique) |
| Quantity | integer | NOT NULL | 0 | Current inventory quantity |
| MinimumStock | integer | NOT NULL | 10 | Minimum stock threshold |
| MaximumStock | integer | NOT NULL | 1000 | Maximum stock capacity |
| ReorderLevel | integer | NOT NULL | 20 | Reorder point |
| LastRestockDate | timestamptz | NULL | - | Last restock timestamp |
| CreatedAt | timestamptz | NOT NULL | NOW | Creation timestamp |
| UpdatedAt | timestamptz | NOT NULL | NOW | Last update timestamp |

**Entity Definition**:
```csharp
public class Inventory
{
    public int Id { get; set; }

    [Required]
    public int ProductId { get; set; }

    [Range(0, int.MaxValue)]
    public int Quantity { get; set; } = 0;

    [Range(0, int.MaxValue)]
    public int MinimumStock { get; set; } = 10;

    [Range(0, int.MaxValue)]
    public int MaximumStock { get; set; } = 1000;

    [Range(0, int.MaxValue)]
    public int ReorderLevel { get; set; } = 20;

    public DateTime? LastRestockDate { get; set; }

    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation property
    public Product Product { get; set; } = null!;

    // Business logic
    public bool IsLowStock => Quantity <= ReorderLevel;
    public bool IsOutOfStock => Quantity == 0;
}
```

**Business Rules**:
- Quantity must be non-negative
- MinimumStock ≤ ReorderLevel ≤ MaximumStock
- One-to-one relationship with Product
- CASCADE delete (deleting product deletes inventory)

---

## Relationships

### One-to-Many: Category → Products

```csharp
// Configuration (Fluent API)
modelBuilder.Entity<Product>()
    .HasOne(p => p.Category)
    .WithMany(c => c.Products)
    .HasForeignKey(p => p.CategoryId)
    .OnDelete(DeleteBehavior.Restrict); // Prevent cascade delete
```

**Behavior**:
- Each Product belongs to exactly one Category
- Each Category can have multiple Products
- Cannot delete Category with existing Products (RESTRICT)

**SQL**:
```sql
ALTER TABLE "Products"
ADD CONSTRAINT "FK_Products_Categories"
FOREIGN KEY ("CategoryId") REFERENCES "Categories" ("Id")
ON DELETE RESTRICT;
```

### One-to-Many: Supplier → Products

```csharp
modelBuilder.Entity<Product>()
    .HasOne(p => p.Supplier)
    .WithMany(s => s.Products)
    .HasForeignKey(p => p.SupplierId)
    .OnDelete(DeleteBehavior.SetNull); // Set NULL on supplier delete
```

**Behavior**:
- Each Product can have zero or one Supplier (optional)
- Each Supplier can supply multiple Products
- Deleting Supplier sets SupplierId to NULL (SET NULL)

**SQL**:
```sql
ALTER TABLE "Products"
ADD CONSTRAINT "FK_Products_Suppliers"
FOREIGN KEY ("SupplierId") REFERENCES "Suppliers" ("Id")
ON DELETE SET NULL;
```

### One-to-One: Product ↔ Inventory

```csharp
modelBuilder.Entity<Inventory>()
    .HasOne(i => i.Product)
    .WithOne(p => p.Inventory)
    .HasForeignKey<Inventory>(i => i.ProductId)
    .OnDelete(DeleteBehavior.Cascade); // Delete inventory with product
```

**Behavior**:
- Each Product can have zero or one Inventory record
- Each Inventory belongs to exactly one Product
- Deleting Product cascades to Inventory (CASCADE)

**SQL**:
```sql
ALTER TABLE "Inventory"
ADD CONSTRAINT "FK_Inventory_Products"
FOREIGN KEY ("ProductId") REFERENCES "Products" ("Id")
ON DELETE CASCADE;

CREATE UNIQUE INDEX "IX_Inventory_ProductId" ON "Inventory" ("ProductId");
```

---

## Indexes

### Users Table

| Index Name | Type | Columns | Purpose |
|------------|------|---------|---------|
| PK_Users | PRIMARY KEY | Id | Unique identifier |
| IX_Users_Username | UNIQUE | Username | Fast login lookup, enforce uniqueness |

### Categories Table

| Index Name | Type | Columns | Purpose |
|------------|------|---------|---------|
| PK_Categories | PRIMARY KEY | Id | Unique identifier |
| IX_Categories_Name | INDEX | Name | Search by name |
| IX_Categories_Discontinued | INDEX | Discontinued | Filter active categories |

### Suppliers Table

| Index Name | Type | Columns | Purpose |
|------------|------|---------|---------|
| PK_Suppliers | PRIMARY KEY | Id | Unique identifier |
| IX_Suppliers_Name | INDEX | Name | Search by name |
| IX_Suppliers_Country | INDEX | Country | Filter by country |
| IX_Suppliers_Discontinued | INDEX | Discontinued | Filter active suppliers |

### Products Table

| Index Name | Type | Columns | Purpose |
|------------|------|---------|---------|
| PK_Products | PRIMARY KEY | Id | Unique identifier |
| IX_Products_CategoryId | INDEX | CategoryId | Join with Categories, filter by category |
| IX_Products_SupplierId | INDEX | SupplierId | Join with Suppliers, filter by supplier |
| IX_Products_Name | INDEX | Name | Search by name |
| IX_Products_SKU | INDEX | SKU | Search by SKU |
| IX_Products_Discontinued | INDEX | Discontinued | Filter active products |
| IX_Products_Price | INDEX | Price | Filter by price range |

### Inventory Table

| Index Name | Type | Columns | Purpose |
|------------|------|---------|---------|
| PK_Inventory | PRIMARY KEY | Id | Unique identifier |
| IX_Inventory_ProductId | UNIQUE | ProductId | One-to-one relationship, fast lookup |

---

## Constraints

### Check Constraints

```sql
-- Products: Price must be non-negative
ALTER TABLE "Products"
ADD CONSTRAINT "CK_Products_Price" CHECK ("Price" >= 0);

-- Products: Stock quantity must be non-negative
ALTER TABLE "Products"
ADD CONSTRAINT "CK_Products_StockQuantity" CHECK ("StockQuantity" >= 0);

-- Inventory: Quantity must be non-negative
ALTER TABLE "Inventory"
ADD CONSTRAINT "CK_Inventory_Quantity" CHECK ("Quantity" >= 0);

-- Inventory: Stock levels must be logical
ALTER TABLE "Inventory"
ADD CONSTRAINT "CK_Inventory_Stock_Levels"
CHECK ("MinimumStock" <= "ReorderLevel" AND "ReorderLevel" <= "MaximumStock");
```

### Unique Constraints

```sql
-- Username must be unique
ALTER TABLE "Users"
ADD CONSTRAINT "UQ_Users_Username" UNIQUE ("Username");

-- ProductId must be unique in Inventory (one-to-one)
ALTER TABLE "Inventory"
ADD CONSTRAINT "UQ_Inventory_ProductId" UNIQUE ("ProductId");
```

### Foreign Key Constraints

```sql
-- Product → Category (RESTRICT)
ALTER TABLE "Products"
ADD CONSTRAINT "FK_Products_Categories"
FOREIGN KEY ("CategoryId") REFERENCES "Categories" ("Id") ON DELETE RESTRICT;

-- Product → Supplier (SET NULL)
ALTER TABLE "Products"
ADD CONSTRAINT "FK_Products_Suppliers"
FOREIGN KEY ("SupplierId") REFERENCES "Suppliers" ("Id") ON DELETE SET NULL;

-- Inventory → Product (CASCADE)
ALTER TABLE "Inventory"
ADD CONSTRAINT "FK_Inventory_Products"
FOREIGN KEY ("ProductId") REFERENCES "Products" ("Id") ON DELETE CASCADE;
```

---

## Migrations

### Migration Strategy

The database uses **Entity Framework Core Code-First Migrations**.

**Migration Workflow**:
```bash
# 1. Create migration
dotnet ef migrations add MigrationName --project ProductCatalog.Infrastructure

# 2. Review migration files
# Check: Migrations/YYYYMMDDHHMMSS_MigrationName.cs

# 3. Apply migration
dotnet ef database update --project ProductCatalog.Infrastructure

# 4. Rollback migration (if needed)
dotnet ef database update PreviousMigrationName --project ProductCatalog.Infrastructure

# 5. Remove last migration (if not applied)
dotnet ef migrations remove --project ProductCatalog.Infrastructure
```

### Migration History

| Migration | Date | Description |
|-----------|------|-------------|
| 20250101000000_InitialCreate | 2025-01-01 | Initial database schema |
| 20250101000001_AddUsersSeed | 2025-01-01 | Add default admin user seed |
| 20250101000002_AddInventoryTable | 2025-01-01 | Add Inventory table for advanced tracking |

### Applying Migrations in Production

**Docker Deployment**:
```bash
# Option 1: Apply migrations on container start
docker compose exec api dotnet ef database update

# Option 2: Run migration in separate container
docker compose run --rm api dotnet ef database update

# Option 3: SQL script generation
dotnet ef migrations script --output migration.sql
psql -U productcatalog -d ProductCatalogDb -f migration.sql
```

**Manual SQL Script**:
```bash
# Generate SQL script for specific migration
dotnet ef migrations script FromMigration ToMigration --output migration.sql

# Apply script manually
psql -U postgres -d ProductCatalogDb -f migration.sql
```

---

## Seed Data

### Default Admin User

```csharp
modelBuilder.Entity<User>().HasData(
    new User
    {
        Id = 1,
        Username = "admin",
        PasswordHash = BCrypt.Net.BCrypt.HashPassword("Admin123!"),
        Role = UserRole.Admin
    }
);
```

**Credentials**:
- Username: `admin`
- Password: `Admin123!`
- Role: Admin

### Sample Categories

```csharp
modelBuilder.Entity<Category>().HasData(
    new Category { Id = 1, Name = "Electronics", Description = "Electronic devices" },
    new Category { Id = 2, Name = "Clothing", Description = "Apparel and accessories" },
    new Category { Id = 3, Name = "Books", Description = "Books and publications" }
);
```

### Sample Suppliers

```csharp
modelBuilder.Entity<Supplier>().HasData(
    new Supplier
    {
        Id = 1,
        Name = "Tech Supplies Inc.",
        ContactName = "John Doe",
        Email = "contact@techsupplies.com",
        Country = "USA"
    }
);
```

---

## Query Examples

### Get All Products with Category

```sql
SELECT p.*, c."Name" AS "CategoryName"
FROM "Products" p
INNER JOIN "Categories" c ON p."CategoryId" = c."Id"
WHERE p."Discontinued" = false
ORDER BY p."Name";
```

**EF Core LINQ**:
```csharp
var products = await _context.Products
    .Include(p => p.Category)
    .Where(p => !p.Discontinued)
    .OrderBy(p => p.Name)
    .ToListAsync();
```

### Get Products by Category with Pagination

```sql
SELECT p.*, c."Name" AS "CategoryName"
FROM "Products" p
INNER JOIN "Categories" c ON p."CategoryId" = c."Id"
WHERE p."CategoryId" = @categoryId AND p."Discontinued" = false
ORDER BY p."Name"
LIMIT @pageSize OFFSET @offset;
```

**EF Core LINQ**:
```csharp
var products = await _context.Products
    .Include(p => p.Category)
    .Where(p => p.CategoryId == categoryId && !p.Discontinued)
    .OrderBy(p => p.Name)
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();
```

### Get Low Stock Products

```sql
SELECT p.*, i."Quantity", i."ReorderLevel"
FROM "Products" p
INNER JOIN "Inventory" i ON p."Id" = i."ProductId"
WHERE i."Quantity" <= i."ReorderLevel"
ORDER BY i."Quantity" ASC;
```

**EF Core LINQ**:
```csharp
var lowStockProducts = await _context.Products
    .Include(p => p.Inventory)
    .Where(p => p.Inventory != null && p.Inventory.Quantity <= p.Inventory.ReorderLevel)
    .OrderBy(p => p.Inventory!.Quantity)
    .ToListAsync();
```

### Get Products by Price Range

```sql
SELECT *
FROM "Products"
WHERE "Price" BETWEEN @minPrice AND @maxPrice
  AND "Discontinued" = false
ORDER BY "Price" ASC;
```

**EF Core LINQ**:
```csharp
var products = await _context.Products
    .Where(p => p.Price >= minPrice && p.Price <= maxPrice && !p.Discontinued)
    .OrderBy(p => p.Price)
    .ToListAsync();
```

### Get Category with Product Count

```sql
SELECT c.*, COUNT(p."Id") AS "ProductCount"
FROM "Categories" c
LEFT JOIN "Products" p ON c."Id" = p."CategoryId" AND p."Discontinued" = false
WHERE c."Discontinued" = false
GROUP BY c."Id"
ORDER BY "ProductCount" DESC;
```

**EF Core LINQ**:
```csharp
var categoriesWithCount = await _context.Categories
    .Where(c => !c.Discontinued)
    .Select(c => new
    {
        Category = c,
        ProductCount = c.Products.Count(p => !p.Discontinued)
    })
    .OrderByDescending(x => x.ProductCount)
    .ToListAsync();
```

### Full-Text Search on Products

```sql
SELECT *
FROM "Products"
WHERE "Name" ILIKE @searchTerm OR "Description" ILIKE @searchTerm
  AND "Discontinued" = false
ORDER BY "Name";
```

**EF Core LINQ**:
```csharp
var products = await _context.Products
    .Where(p => (p.Name.Contains(searchTerm) || p.Description!.Contains(searchTerm))
                && !p.Discontinued)
    .OrderBy(p => p.Name)
    .ToListAsync();
```

---

## Database Backup and Restore

### Backup

```bash
# Full database backup
pg_dump -U productcatalog -d ProductCatalogDb -F c -f backup.dump

# SQL format backup
pg_dump -U productcatalog -d ProductCatalogDb -f backup.sql

# Compressed backup
pg_dump -U productcatalog -d ProductCatalogDb | gzip > backup.sql.gz
```

### Restore

```bash
# Restore from custom format
pg_restore -U productcatalog -d ProductCatalogDb backup.dump

# Restore from SQL file
psql -U productcatalog -d ProductCatalogDb -f backup.sql

# Restore from compressed backup
gunzip -c backup.sql.gz | psql -U productcatalog -d ProductCatalogDb
```

---

## Performance Tuning

### Query Optimization

**Use Indexes**:
```csharp
// ✅ Good - Uses index on CategoryId
var products = await _context.Products
    .Where(p => p.CategoryId == categoryId)
    .ToListAsync();

// ❌ Bad - No index on Description
var products = await _context.Products
    .Where(p => p.Description.Contains("keyword"))
    .ToListAsync();
```

**Eager Loading**:
```csharp
// ✅ Good - Single query with JOIN
var products = await _context.Products
    .Include(p => p.Category)
    .Include(p => p.Supplier)
    .ToListAsync();

// ❌ Bad - N+1 queries
var products = await _context.Products.ToListAsync();
foreach (var product in products)
{
    var category = await _context.Categories.FindAsync(product.CategoryId);
}
```

### Connection Pooling

Connection pooling is enabled by default in Npgsql:

```csharp
// Connection string with pooling settings
"Host=localhost;Port=5432;Database=ProductCatalogDb;Username=postgres;Password=postgres;Pooling=true;MinPoolSize=1;MaxPoolSize=100"
```

---

## Monitoring

### Database Size

```sql
SELECT pg_size_pretty(pg_database_size('ProductCatalogDb'));
```

### Table Sizes

```sql
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname || '.' || tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname || '.' || tablename) DESC;
```

### Active Connections

```sql
SELECT count(*) FROM pg_stat_activity WHERE datname = 'ProductCatalogDb';
```

### Slow Queries

```sql
SELECT
    query,
    calls,
    total_time,
    mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

---

## Security

### Database User Permissions

**Production Setup**:
```sql
-- Create dedicated user
CREATE USER productcatalog WITH PASSWORD 'securepassword';

-- Grant minimal permissions
GRANT CONNECT ON DATABASE ProductCatalogDb TO productcatalog;
GRANT USAGE ON SCHEMA public TO productcatalog;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO productcatalog;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO productcatalog;
```

**Development Setup**:
```sql
-- Grant all permissions for development
GRANT ALL PRIVILEGES ON DATABASE ProductCatalogDb TO postgres;
```

### Connection Security

- ✅ Use SSL/TLS in production
- ✅ Store connection strings in environment variables
- ✅ Use separate users for different environments
- ✅ Rotate passwords regularly
- ✅ Enable connection encryption

---

## Troubleshooting

### Reset Database

```bash
# Drop and recreate database
dotnet ef database drop --project ProductCatalog.Infrastructure --force
dotnet ef database update --project ProductCatalog.Infrastructure
```

### View Applied Migrations

```bash
dotnet ef migrations list --project ProductCatalog.Infrastructure
```

### Check Database Connection

```bash
# From API container
docker compose exec api dotnet ef database update --project ProductCatalog.Infrastructure

# From PostgreSQL
docker compose exec postgres psql -U productcatalog -d ProductCatalogDb -c "SELECT version();"
```

---

## Summary

The ProductCatalog database schema is designed with:

✅ **Normalization** - Third normal form (3NF)
✅ **Referential Integrity** - Foreign key constraints
✅ **Performance** - Strategic indexes on frequently queried columns
✅ **Flexibility** - Soft deletes, optional relationships
✅ **Scalability** - Pagination support, efficient queries
✅ **Security** - Minimal permissions, encrypted connections
✅ **Maintainability** - Code-First migrations, clear relationships

---

## Additional Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [EF Core Documentation](https://docs.microsoft.com/en-us/ef/core/)
- [Database Design Best Practices](https://www.postgresql.org/docs/current/ddl.html)
- [EF Core Migrations](https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/)

---

**[← Back to Documentation](../README.md#documentation)**
