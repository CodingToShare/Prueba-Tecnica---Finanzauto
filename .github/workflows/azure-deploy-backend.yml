name: Build and Deploy Backend to Azure

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Backend/**'
      - '.github/workflows/azure-deploy-backend.yml'
      - 'Dockerfile'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ${{ secrets.ACR_URL }}
  IMAGE_NAME: productcatalog-api

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_URL }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure App Service Settings
        run: |
          echo "üîß Configuring App Service environment variables..."
          az webapp config appsettings set \
            --name ${{ secrets.AZURE_BACKEND_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              ConnectionStrings__ProductCatalogDb="${{ secrets.POSTGRES_CONNECTION_STRING }}" \
              ASPNETCORE_ENVIRONMENT="Production" \
              JWT__Key="${{ secrets.JWT_KEY }}" \
              JWT__Issuer="ProductCatalogAPI" \
              JWT__Audience="ProductCatalogClients" \
              JWT__ExpirationHours="24"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_BACKEND_APP_NAME }}
          slot-name: production
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for container startup
        run: |
          echo "‚è≥ Waiting for container to start and complete initialization..."
          echo "This includes: Database migrations ‚Üí Table renaming ‚Üí Seed data"
          echo "Estimated time: 2-3 minutes"
          sleep 120

      - name: Check App Service logs
        run: |
          echo "üìã Checking recent application logs..."
          az webapp log tail \
            --name ${{ secrets.AZURE_BACKEND_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --only-show-errors \
            2>&1 | head -50 || echo "Could not fetch logs"

      - name: Run Health Check
        run: |
          echo "üè• Running health checks..."
          
          # Basic health check with retries
          for i in {1..10}; do
            echo "Attempt $i/10: Checking basic health..."
            if curl -f -m 10 https://${{ secrets.AZURE_BACKEND_APP_NAME }}.azurewebsites.net/health; then
              echo "‚úÖ Basic health check passed!"
              break
            else
              if [ $i -eq 10 ]; then
                echo "‚ùå Health check failed after 10 attempts"
                exit 1
              fi
              echo "‚è≥ Health check failed, waiting 30 seconds before retry..."
              sleep 30
            fi
          done

          # Check Swagger UI
          echo "üìö Checking Swagger UI availability..."
          curl -I https://${{ secrets.AZURE_BACKEND_APP_NAME }}.azurewebsites.net/swagger || echo "‚ö†Ô∏è Swagger check failed"

      - name: Test Authentication Endpoint
        run: |
          echo "üîê Testing authentication endpoint..."
          curl -X POST https://${{ secrets.AZURE_BACKEND_APP_NAME }}.azurewebsites.net/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"Admin123!"}' \
            -f -m 10 || echo "‚ö†Ô∏è Auth endpoint check failed (might be expected if no seed data)"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê API URL: https://${{ secrets.AZURE_BACKEND_APP_NAME }}.azurewebsites.net"
          echo "üìö Swagger: https://${{ secrets.AZURE_BACKEND_APP_NAME }}.azurewebsites.net/swagger"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed"
          echo "Check logs at: https://portal.azure.com"
